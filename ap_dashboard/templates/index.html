<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Artificial Pancreas â€“ Results Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <h1>Artificial Pancreas â€“ MATLAB Results</h1>

    <button id="refreshBtn">ðŸ”„ Refresh Data</button>

    <div class="charts">
        <div class="card">
            <h2>Glucose</h2>
            <canvas id="glucoseChart"></canvas>
        </div>
        <div class="card">
            <h2>Insulin & Meal</h2>
            <canvas id="insulinChart"></canvas>
        </div>
    </div>
</div>

<script>
let glucoseChart, insulinChart;

async function fetchResults() {
    const res = await fetch("/api/results");
    return await res.json();
}

function drawCharts(data) {
    const labels = data.t || [];
    const glucose = data.glucose || [];
    const insulin = data.insulin || [];
    const meal = data.meal || [];

    const ctxG = document.getElementById("glucoseChart").getContext("2d");
    const ctxI = document.getElementById("insulinChart").getContext("2d");

    if (glucoseChart) glucoseChart.destroy();
    if (insulinChart) insulinChart.destroy();

    glucoseChart = new Chart(ctxG, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Glucose",
                data: glucose,
                borderWidth: 2,
                fill: false,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: "Time (min)" } },
                y: { title: { display: true, text: "Glucose (arb units)" } }
            }
        }
    });

    insulinChart = new Chart(ctxI, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Insulin",
                    data: insulin,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: "Meal",
                    data: meal,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    borderDash: [5,5]
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: "Time (min)" } },
                y: { title: { display: true, text: "Arbitrary units" } }
            }
        }
    });
}

async function refresh() {
    const data = await fetchResults();
    drawCharts(data);
}

document.getElementById("refreshBtn").addEventListener("click", refresh);

// Page load pe ek baar data lao
window.addEventListener("load", refresh);
</script>
</body>
</html>
