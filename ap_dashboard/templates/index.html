<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Artificial Pancreas – Analysis Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* increase default font size by 5px */
      font-size: 23px;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      padding: 1rem 2rem;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    .btn {
      background: #22c55e;
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      color: #022c22;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .container {
      padding: 1.5rem 2rem 2rem;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #020617;
      /* increase card radius and padding to make card larger by 10px */
      border-radius: calc(0.8rem + 10px);
      padding: calc(0.9rem + 10px) calc(1rem + 10px);
      border: 1px solid #1e293b;
    }
    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 0.4rem;
    }
    .card-value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap: 1.5rem;
    }
    .panel {
      background: #020617;
      border-radius: calc(0.8rem + 10px);
      padding: calc(1rem + 10px);
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      align-items: center; /* center child content horizontally */
    }
    .panel h2 {
      font-size: 1rem;
      margin: 0 0 0.6rem 0;
    }
    /* Center charts and allow larger height for clearer visuals */
    canvas {
      display: block;
      margin: 0.4rem auto;
      max-height: 480px; /* increased from 320 */
      width: 100% !important;
    }

    /* Target glucose chart specific tweaks (keeps it centered and taller) */
    #glucoseChart {
      max-height: 480px;
      width: 100% !important;
    }

    /* Slightly taller insulin/meal charts for clarity */
    #insulinChart,
    #mealChart {
      max-height: 320px;
      width: 100% !important;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Blood Glucose Regulation – Artificial Pancreas</h1>
    <button class="btn" onclick="refreshAll()">Refresh Data</button>
  </header>

  <div class="container">
    <!-- Summary cards -->
    <div class="cards">
      <div class="card">
        <div class="card-title">Mean Glucose</div>
        <div class="card-value" id="mean-glucose">–</div>
      </div>
      <div class="card">
        <div class="card-title">Min / Max Glucose</div>
        <div class="card-value" id="minmax-glucose">–</div>
      </div>
      <div class="card">
        <div class="card-title">Std Dev</div>
        <div class="card-value" id="std-glucose">–</div>
      </div>
      <div class="card">
        <div class="card-title">Time In Range (70–180)</div>
        <div class="card-value" id="tir">–</div>
      </div>
      <div class="card">
        <div class="card-title">Time Below Range</div>
        <div class="card-value" id="tbr">–</div>
      </div>
      <div class="card">
        <div class="card-title">Time Above Range</div>
        <div class="card-value" id="tar">–</div>
      </div>
      <div class="card">
        <div class="card-title">Hypo / Hyper Episodes</div>
        <div class="card-value" id="episodes">–</div>
      </div>
      <div class="card">
        <div class="card-title">IAE / ISE</div>
        <div class="card-value" id="errors">–</div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Glucose vs Time</h2>
        <canvas id="glucoseChart"></canvas>
      </div>
      <div class="panel">
        <h2>Insulin Input & Meals</h2>
        <canvas id="insulinChart"></canvas>
        <canvas id="mealChart" style="margin-top: 1rem;"></canvas>
      </div>
    </div>
  </div>

  <script>
    let glucoseChart, insulinChart, mealChart;

    async function fetchJSON(url) {
      const res = await fetch(url);
      return await res.json();
    }

    function initOrUpdateChart(chartRef, ctx, config) {
      if (chartRef) {
        chartRef.data = config.data;
        chartRef.options = config.options;
        chartRef.update();
        return chartRef;
      } else {
        return new Chart(ctx, config);
      }
    }

    async function loadResults() {
      const data = await fetchJSON("/api/results");

      const t = data.t || [];
      const glucose = data.glucose || [];
      const insulin = data.insulin_input || [];
      const meal = data.meal || [];
      const target = data.target || [];

      // Glucose chart with target
      const gCtx = document.getElementById("glucoseChart").getContext("2d");
        // Set chart-wide defaults for clarity / higher DPI
        Chart.defaults.font.size = 16; // larger labels
        // Chart.js picks up devicePixelRatio automatically in many versions; set if available
        try {
          Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;
        } catch(e) {}

      glucoseChart = initOrUpdateChart(glucoseChart, gCtx, {
        type: "line",
        data: {
          labels: t,
          datasets: [
            {
              label: "Glucose (mg/dL)",
              data: glucose,
              borderWidth: 3,
              pointRadius: 2,
              pointHoverRadius: 4,
              tension: 0.15,
            },
            {
              label: "Target (100 mg/dL)",
              data: target.length ? target : glucose.map(() => 100),
              borderWidth: 1,
              borderDash: [6, 4],
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
          },
          scales: {
            x: {
              title: { display: true, text: "Time (min)", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#1f2937" },
            },
            y: {
              title: { display: true, text: "Glucose (mg/dL)", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#111827" },
              suggestedMin: 40,
              suggestedMax: 260,
            }
          },
          elements: {
            line: { tension: 0.4 },
            point: { radius: 2 },
          },
          layout: {
            padding: { left: 12, right: 12, top: 12, bottom: 12 }
          }
        }
      });

      // Insulin chart
      const iCtx = document.getElementById("insulinChart").getContext("2d");
      insulinChart = initOrUpdateChart(insulinChart, iCtx, {
        type: "line",
        data: {
          labels: t,
          datasets: [
            {
              label: "Insulin Infusion (U/min)",
              data: insulin,
              borderWidth: 2,
              pointRadius: 2,
              tension: 0.15,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
          },
          scales: {
            x: {
              title: { display: true, text: "Time (min)", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#1f2937" },
            },
            y: {
              title: { display: true, text: "Insulin (arb. units)", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#111827" },
            }
          },
          layout: { padding: { left: 8, right: 8, top: 8, bottom: 8 } }
        }
      });

      // Meal chart
      const mCtx = document.getElementById("mealChart").getContext("2d");
      mealChart = initOrUpdateChart(mealChart, mCtx, {
        type: "bar",
        data: {
          labels: t,
          datasets: [
            {
              label: "Meal Input",
              data: meal,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
          },
          scales: {
            x: {
              title: { display: true, text: "Time (min)", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#1f2937" },
            },
            y: {
              title: { display: true, text: "Relative Carb Input", color: "#9ca3af" },
              ticks: { color: "#9ca3af" },
              grid: { color: "#111827" },
            }
          },
          layout: { padding: { left: 8, right: 8, top: 8, bottom: 8 } }
        }
      });
    }

    async function loadSummary() {
      const s = await fetchJSON("/api/summary");

      const fmt = (v, suf = "") =>
        v == null ? "–" : v.toFixed(1) + (suf ? " " + suf : "");

      document.getElementById("mean-glucose").textContent =
        fmt(s.g_mean, "mg/dL");

      document.getElementById("minmax-glucose").textContent =
        (s.g_min == null || s.g_max == null)
          ? "–"
          : s.g_min.toFixed(1) + " / " + s.g_max.toFixed(1) + " mg/dL";

      document.getElementById("std-glucose").textContent =
        fmt(s.g_std, "mg/dL");

      document.getElementById("tir").textContent =
        fmt(s.time_in_range_pct, "%");

      document.getElementById("tbr").textContent =
        fmt(s.time_below_range_pct, "%");

      document.getElementById("tar").textContent =
        fmt(s.time_above_range_pct, "%");

      document.getElementById("episodes").textContent =
        (s.hypo_episodes == null || s.hyper_episodes == null)
          ? "–"
          : s.hypo_episodes + " hypo / " + s.hyper_episodes + " hyper";

      document.getElementById("errors").textContent =
        (s.iae == null || s.ise == null)
          ? "–"
          : "IAE " + s.iae.toFixed(1) + ", ISE " + s.ise.toFixed(1);
    }

    async function refreshAll() {
      await Promise.all([loadResults(), loadSummary()]);
    }

    // Initial load
    refreshAll();

    // Optional: auto-refresh every 15 seconds
    // setInterval(refreshAll, 15000);
  </script>
</body>
</html>
